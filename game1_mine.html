import pygame
import random
import sys

# --- 定数 ---
GRID_SIZE = 10         # グリッドの行数・列数
CELL_SIZE = 40         # セルの1辺のピクセル数
MARGIN = 20            # グリッドを描画する余白
NUM_MINES = 10         # 地雷の数
NUM_TREASURES = 5      # 宝箱の数

# ウィンドウサイズ（余白分含む）
WINDOW_WIDTH = GRID_SIZE * CELL_SIZE + 2 * MARGIN  # 10*40 + 40 = 440
WINDOW_HEIGHT = WINDOW_WIDTH

# 色定義
LIGHT_GRAY = (211, 211, 211)  # 未オープンセル
WHITE = (255, 255, 255)       # オープンセル
YELLOW_GREEN = (173, 255, 47) # 地雷原外の背景
GRAY_BORDER = (153, 153, 153) # セルの枠色
BLACK = (0, 0, 0)
RED = (255, 0, 0)

# --- Pygame 初期化 ---
pygame.init()
screen = pygame.display.set_mode((WINDOW_WIDTH, WINDOW_HEIGHT))
pygame.display.set_caption("トレジャーマインス")
clock = pygame.time.Clock()

# フォント
font = pygame.font.SysFont("Arial", 20)

# 宝箱画像の読み込み（takarabako.png は同一ディレクトリに配置）
try:
    treasure_img = pygame.image.load("takarabako.png").convert_alpha()
    treasure_img = pygame.transform.smoothscale(treasure_img, (CELL_SIZE, CELL_SIZE))
except pygame.error:
    print("宝箱画像（takarabako.png）の読み込みに失敗しました。")
    sys.exit()

# --- ゲームデータ ---
# 盤面（値：0=初期、-1=地雷、9=宝箱、数字=周囲の地雷数）
board = [[0 for _ in range(GRID_SIZE)] for _ in range(GRID_SIZE)]
# セルの表示状態（True: 表示済み、False: 未表示）
revealed = [[False for _ in range(GRID_SIZE)] for _ in range(GRID_SIZE)]
treasure_found = 0
game_over = False
game_clear = False

def place_objects(num, obj_type):
    count = 0
    while count < num:
        x = random.randint(0, GRID_SIZE - 1)
        y = random.randint(0, GRID_SIZE - 1)
        if board[y][x] == 0:
            board[y][x] = obj_type
            count += 1

# --- 地雷と宝箱の配置 ---
place_objects(NUM_MINES, -1)      # 地雷は -1
place_objects(NUM_TREASURES, 9)     # 宝箱は 9

# --- 周囲の地雷数の計算 ---
def calculate_numbers():
    for y in range(GRID_SIZE):
        for x in range(GRID_SIZE):
            # 既に地雷または宝箱ならスキップ
            if board[y][x] in (-1, 9):
                continue
            count = 0
            for dy in range(-1, 2):
                for dx in range(-1, 2):
                    nx, ny = x + dx, y + dy
                    if 0 <= nx < GRID_SIZE and 0 <= ny < GRID_SIZE:
                        if board[ny][nx] == -1:
                            count += 1
            board[y][x] = count

calculate_numbers()

# --- 描画 ---
def draw_board():
    # 背景を黄緑で塗りつぶす（地雷原外）
    screen.fill(YELLOW_GREEN)
    
    # 地雷原の枠（グリッド部分）を描画
    grid_rect = pygame.Rect(MARGIN, MARGIN, GRID_SIZE * CELL_SIZE, GRID_SIZE * CELL_SIZE)
    pygame.draw.rect(screen, BLACK, grid_rect, 2)
    
    # 各セルを描画
    for y in range(GRID_SIZE):
        for x in range(GRID_SIZE):
            cell_x = MARGIN + x * CELL_SIZE
            cell_y = MARGIN + y * CELL_SIZE
            # 未オープン: 薄い灰色, オープン: 白
            color = WHITE if revealed[y][x] else LIGHT_GRAY
            cell_rect = pygame.Rect(cell_x, cell_y, CELL_SIZE, CELL_SIZE)
            pygame.draw.rect(screen, color, cell_rect)
            # セルの枠
            pygame.draw.rect(screen, GRAY_BORDER, cell_rect, 1)
            
            # セルが開かれている場合、内容を描画
            if revealed[y][x]:
                if board[y][x] == -1:
                    # 地雷なら赤い円を描く
                    pygame.draw.circle(screen, RED, (cell_x + CELL_SIZE // 2, cell_y + CELL_SIZE // 2), CELL_SIZE // 4)
                elif board[y][x] == 9:
                    # 宝箱なら画像を描画
                    screen.blit(treasure_img, (cell_x, cell_y))
                elif board[y][x] > 0:
                    # 数字を描画（0の場合は何も描かない）
                    text = font.render(str(board[y][x]), True, BLACK)
                    screen.blit(text, (cell_x + 10, cell_y + 10))

# --- セルを開く ---
def reveal_cell(x, y):
    global treasure_found, game_over, game_clear
    if revealed[y][x]:
        return
    revealed[y][x] = True
    if board[y][x] == -1:
        game_over = True
    elif board[y][x] == 9:
        treasure_found += 1
        if treasure_found == NUM_TREASURES:
            game_clear = True

# --- メインループ ---
running = True
while running:
    for event in pygame.event.get():
        if event.type == pygame.QUIT:
            running = False
        elif event.type == pygame.MOUSEBUTTONDOWN and event.button == 1 and not (game_over or game_clear):
            mx, my = pygame.mouse.get_pos()
            # マージンを考慮してグリッド内のセル座標を算出
            if MARGIN <= mx < MARGIN + GRID_SIZE * CELL_SIZE and MARGIN <= my < MARGIN + GRID_SIZE * CELL_SIZE:
                cell_x = (mx - MARGIN) // CELL_SIZE
                cell_y = (my - MARGIN) // CELL_SIZE
                reveal_cell(cell_x, cell_y)
    
    draw_board()
    
    # ゲーム終了メッセージ表示
    if game_over or game_clear:
        overlay = pygame.Surface((WINDOW_WIDTH, WINDOW_HEIGHT))
        overlay.set_alpha(180)
        overlay.fill((0, 0, 0))
        screen.blit(overlay, (0, 0))
        if game_over:
            msg = "ゲームオーバー！"
        else:
            msg = "全ての宝箱を見つけた！ゲームクリア！"
        text = font.render(msg, True, WHITE)
        text_rect = text.get_rect(center=(WINDOW_WIDTH//2, WINDOW_HEIGHT//2))
        screen.blit(text, text_rect)
    
    pygame.display.flip()
    clock.tick(30)

pygame.quit()
